# 認証

## Web UI認証

- **方式:** Supabaseが提供するメールアドレスとパスワードによる認証を利用する。
- **ライブラリ:** フロントエンド（React）で `@supabase/supabase-js` を使用して実装する。

## APIキー認証 (Google Apps Script)

- **目的:** Google Apps ScriptからのHTTPリクエストが、正当なアプリケーションから送信されたものであることを認証する。
- **キー管理:** アプリケーション全体で単一の固定APIキーを使用する。このキーはバックエンドの環境変数（Secret）として管理し、GAS側にも同じ値を設定する。

### 認証フロー

1. **[GAS] リクエスト送信:**
   - GASは、`Authorization: Bearer <固定APIキー>` ヘッダーを付与して、バックエンド (`/api/effort`) にリクエストを送信する。
2. **[バックエンド] 固定APIキー検証:**
   - バックエンドは、リクエストヘッダーのAPIキーと、環境変数に設定されたAPIキーが一致するかを検証する。
   - 一致しない場合、`401 Unauthorized` エラーを返す。
3. **[バックエンド] ユーザー特定:**
   - APIキーが有効な場合、リクエストペイロードに含まれるメールアドレス (`email`) を取得する。
   - 取得したメールアドレスを基に、データベースの `auth.users` テーブルを検索し、ユーザー情報を特定する。
   - ユーザーが見つからない場合、`400 Bad Request` などのエラーを返す。

## フロントエンド・バックエンド間 認証フロー

フロントエンド（React）からバックエンド（Hono）のAPIを呼び出す際の認証は、以下の流れで行う。

1. **[フロント] ログイン:**
   - ユーザーがメールアドレスとパスワードでログインする。
   - Supabaseから返却されたJWT（アクセストークン）は `@supabase/supabase-js` によって自動的にブラウザのLocalStorageに保存される。
2. **[フロント] APIリクエスト:**
   - APIを呼び出す際、LocalStorageからJWTを取得する。
   - 取得したJWTを、`axios` などのHTTPクライアントを使い、リクエストの `Authorization: Bearer <JWT>` ヘッダーに設定してバックエンドに送信する。
3. **[バックエンド] リクエスト検証:**
   - APIエンドポイントは、まずリクエストヘッダーからJWTを検証する。
   - SupabaseのAdminクライアント (`service_role` キーを使用) の `getUser(jwt)` 関数を呼び出し、JWTが有効であり、どのユーザーのものかを検証する。
   - 検証に成功した場合のみ、後続の処理を実行する。

