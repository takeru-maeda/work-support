# フロントエンド設計

## 画面要件

- **ホーム画面 (`/`)**
  - アプリ全体のハブとして、主要機能（工数登録・目標管理・週報出力）へのカード型リンクを配置する。
  - 固定ヘッダーに現在ログイン中ユーザーのメニュー、テーマ切り替え、グローバルナビゲーションを持つ。
- **工数登録画面 (`/efforts/new`)**
  - 日付選択、工数エントリ一覧、サマリー（案件別集計）を表示する。
  - 工数エントリは案件カード単位でドラッグ＆ドロップ並び替えができ、既存案件・タスク候補から選択、見積／実績工数入力、メモ入力を行う。
  - 入力内容はローカルストレージに自動保存し、送信後にリセットする。
  - 入力の度に `PUT /api/effort/draft` へドラフトを同期し、画面初期化時は `GET /api/effort/draft` を通じて `work_entry_drafts` から復元する。
  - 案件・タスク候補は `GET /api/projects` を利用してユーザー専用マスターを取得する。
  - 画面遷移時に `GET /api/projects` と `GET /api/effort/draft` を並列で呼び出し、取得した案件・タスクをコンボボックスへ表示する。ドラフトが存在する場合はフォームへ初期反映する。
  - 実績工数 (`hours`) は必須入力とし、空の場合は送信できない。
  - フォームの Undo / Redo は Immer の `produceWithPatches` と `applyPatches` を用いたヒストリー管理で実装し、`past` / `future` スタックを保持してキーボードショートカット（Cmd/Ctrl + Z / Shift + Cmd/Ctrl + Z）および UI ボタンから切り替えられるようにする。
  - 工数集計カードは以下のルールで算出する:
    - 案件別集計
      - 「見積」はタスクで入力された `estimatedHours` の合計。1件も入力がなければ `-` を表示する。
      - 「実績」は `actualHours` の合計。見積有無に関係なく常に数値を表示する。
      - 「差分」は見積が入力されているタスクのみを対象に `実績 - 見積` を算出する。見積が1件も無い場合は `-` を表示する。
    - 全体集計
      - 案件別と同様に、見積のあるタスクだけを対象に差分を算出する。
      - 全体で見積が1件もない場合は見積合計と差分を `-` とする。
- **工数一覧画面 (`/efforts`)**
  - 登録済み工数を一覧で表示し、必要に応じて期間（日付の開始日・終了日）、案件、タスクによる絞り込みと並び替え機能を提供する。プロジェクト／タスクの絞り込みは ID で送信するが、UI 上は名称を表示する。
  - 画面遷移時に `localStorage` に保存されている絞り込み・並び替え条件（開始日・終了日ペアを含む）を読込み、条件が存在する場合は `GET /api/reports/work-records` をその条件で実行して初期表示を行う（未保存の場合はデフォルト条件で取得する）。
  - 絞り込みボタン押下時は現在のフォーム入力値（開始日・終了日を含む）を `GET /api/reports/work-records` のクエリに反映して再取得し、使用した条件を `localStorage` に保存する。
  - クリアボタン押下時は絞り込み条件を初期状態に戻し、条件なしで `GET /api/reports/work-records` を実行するとともに `localStorage` に保存していた条件を削除する。
- **目標管理画面 (`/goals`)**
  - 最新期間の目標一覧をテーブル表示し、各行の更新ボタンから目標（タイトル）、ウェイト、進捗率を一括更新できる。ウェイト合計が100%でない場合は更新ボタンを非活性とする。初期表示は `GET /api/goals/current` のレスポンスを使用する。
  - 内容（詳細記述）は行内リンクから開くダイアログで編集し、保存時に `PUT /api/goals/:id` へ内容を送信する。
  - 期間フィールドは表示のみとし、UIから編集不可とする。
  - 削除ボタン押下時は確認ダイアログを表示し、目標タイトルと一致するテキストが入力された場合のみ最終削除操作（`DELETE /api/goals/:id`）を許可する。
  - 目標一覧のヘッダーでは、取得した現在目標を用いて以下の指標をリアルタイムに算出し表示する。
    - **全体進捗率:** `SUM(goal.progress) / 目標件数` を算出する。
    - **加重進捗率:** `SUM(goal.progress * goal.weight / 100)` を計算する（ウェイト合計が100、進捗率が0〜100である前提のため上限超過は発生しない）。
  - 過去目標タブでは検索条件（キーワード、期間、進捗率範囲）・並び替え・ページネーションを提供し、変更された条件を `localStorage` に保存してリロード時に自動復元する。データ取得には `GET /api/goals/history` を利用する。
    - 画面遷移時は `localStorage` に保存された絞り込み・並び替え条件を参照し、条件が存在する場合は `GET /api/goals/history` をその条件で実行する（条件がない場合はデフォルト値で取得する）。
    - 絞り込みボタン押下時は入力された条件で `GET /api/goals/history` を呼び出し、利用した条件を `localStorage` に保存する。
    - クリアボタン押下時は検索条件を初期化し、条件なしで `GET /api/goals/history` を実行した上で `localStorage` の保存内容を削除する。
- 目標追加ダイアログではタイトル・期間・ウェイト・内容を登録し、作成時に「期間は後から変更できない」「既存の目標が編集不可になる」旨を警告する。保存前に既存期間より未来日であることを検証する。
- 保存ボタン押下時は「保存すると現在の最新目標が編集できなくなる」旨の確認ダイアログを表示し、ユーザーが同意した場合のみ保存処理を実行する。キャンセルした場合は入力内容を保持したままダイアログを閉じる。
  - 週間レポート用に `GET /api/goals/progress/previous-week` を呼び出し、前週との差分を表示できるようにする。
- **週報出力画面 (`/weekly-report`)**
  - ミッション編集フォームと週報プレビューを表示する。
  - 日付選択で対象週を切り替え、ミッション・工数・目標サマリーを整形したテキストで確認できる。
- **ログイン画面 (`/login`)**
  - メールアドレスとパスワードでログインするフォームを提供する。
  - Supabase SDKを利用してサインインし、成功後は認証済みルートへリダイレクトする。
- **サインアップ画面 (`/signup`)**
  - メールアドレスとパスワードでアカウントを作成するフォームを提供する。
  - Supabase SDKでの登録成功後、`POST /api/user-settings` を呼び出して通知設定を初期化し、確認画面またはログイン画面へ遷移する。
- **プロフィール画面 (`/profile`)**
  - ユーザーの基本情報（名前・メール）を表示し、名前およびプロフィール画像のみ更新できる。
  - 画面下部に「アカウント削除」ボタンを配置し、押下時は確認ダイアログを表示する。
    - ダイアログでは「操作は取り消せない」旨を表示し、ユーザーのメールアドレスを入力させる。
    - 入力値が現在のメールアドレスと一致した場合のみ削除ボタンを有効化する。
    - 削除実行後は Supabase Auth のユーザー削除 API を呼び出し、成功したら即座にログアウトして `/login` へ遷移する。
- **パスワードリセット画面**
  - リセットメール送信画面 (`/reset-password`) でメールアドレスを入力すると Supabase SDK 経由でリセットメールを送信する。
  - リセットリンクから遷移する画面では新しいパスワードを入力し、`updatePassword` を実行する。
- **目標追加画面 (`/goals/add`)**
  - 最新期間の目標へ新規レコードを追加するフォームを提供する。
  - 作成時に期間は必ず既存期間より未来日時であることをバリデーションし、保存成功後に目標一覧へリダイレクトする。
  - 保存前に確認ダイアログを表示し、ユーザーが承認した場合のみ `POST /api/goals` を連続実行して目標を作成する。
  - 編集中のフォーム内容（期間・目標リスト）を `localStorage` へ自動保存し、リロードや離脱後も再編集できるようにする。
  - 保存が成功した際は `localStorage` に保持しているドラフトを削除し、次回表示時に初期状態へ戻す。
  - 画面遷移時（初期表示時）は `localStorage` のドラフトを読み込み、存在する場合はフォームへ復元する。
- **設定画面 (`/settings`)** *(実装予定)*
  - 画面初期化時に `GET /api/user-settings` を呼び出し、現在の通知設定を取得して初期表示する。
  - 工数登録完了メール通知のオン/オフを切り替えるトグルを提供し、`user_settings.notify_effort_email` と同期する。

## 共通モジュール／フロー

- **エラーログ送信モジュール**
  - 共通モジュール（例: `features/logs/services/errorLogger.ts`）を作成し、UI 全体で発生した例外や想定外エラーを `POST /api/logs/error` に送信する。
  - 送信時には `source` に `UI` を設定し、`userAgent` / `pageUrl` / `appVersion` / 画面固有のメタデータを付与する。
  - 重大なエラー発生時にはユーザー向けのトーストや画面遷移制御を組み合わせることを検討する。
- **サインアップフロー**
  - Supabase SDKで会員登録が完了したら、バックエンドの `POST /api/user-settings` を呼び出して通知設定を初期化する（ボディは不要）。

## アーキテクチャ

フロントエンドは Vite + React Router で構成する SPA とし、UI は shadcn/ui をベースに**Balletproof（Bulletproof React を基にした本プロジェクト向け拡張）構成**で再利用性と可読性を確保する。Balletproof では「アプリ全体の骨格」「機能ごとの境界」「共有資産」をレイヤー分割し、関心の分離を徹底する。

### Balletproof ディレクトリ構成（計画） `packages/web/src`

```
packages/web/src/
├── app/                  # アプリ全体のセットアップ（プロバイダ、router、エラーバウンダリ）
│   ├── App.tsx
│   ├── main.tsx
│   └── providers.tsx など
├── pages/                # ルーティング単位のページ（React Router の element 実体）
│   ├── home/
│   │   └── HomePage.tsx
│   ├── efforts/
│   │   ├── EffortsPage.tsx
│   │   └── EffortsNewPage.tsx
│   ├── goals/
│   │   └── GoalsPage.tsx
│   ├── weekly-report/
│   │   └── WeeklyReportPage.tsx
│   ├── profile/
│   │   └── ProfilePage.tsx
│   └── auth/
│       ├── LoginPage.tsx
│       └── SignupPage.tsx
├── features/             # 各機能境界で UI / hooks / services / schema を集約
│   ├── goals/
│   │   ├── components/
│   │   ├── hooks/
│   │   ├── services/
│   │   └── types.ts
│   ├── mission/
│   ├── reports/
│   └── effort/
├── components/
│   ├── layout/           # app-header などレイアウト用複合コンポーネント
│   ├── shared/           # 複数 feature から利用する複合 UI
│   └── ui/               # shadcn/ui ベースのスタンドアロン部品
├── hooks/                # 複数 feature で再利用されるカスタムフック
├── lib/                  # 日付計算、認証ラッパー、API クライアントなど共通ロジック
├── services/             # API 通信やローカルストレージ I/O を抽象化
├── store/                # Zustand 等で管理するグローバル状態（例: テーマ）
├── styles/               # Tailwind v4 テーマとグローバル CSS
├── config/               # 環境変数やルーティング設定等の集中管理（例: routes.ts）
├── types/                # 型共有（API スキーマは `packages/shared` をインポート）
└── index.css             # グローバルスタイルのエントリーポイント
```

> **Note:** 現在の実装は段階的に BalletProof へ移行中であり、今後のスプリントで上記構成に合わせてリファクタリングする。

## 主要な技術要素の役割

- **ルーティング (`React Router`)**:
  - `/`, `/efforts`, `/efforts/new`, `/goals`, `/weekly-report`, `/profile`, `/login`, `/signup` などのパスを `Routes` で管理する。
  - `AuthGuard` コンポーネントを利用して、認証が必要なルートで未ログイン時に `/login` へ遷移させる。
- **コンポーネント (`React`, `shadcn/ui`)**:
  - `components/ui` には `shadcn/ui` から導入した再利用可能な最小単位のコンポーネントを配置する。
  - ページ固有の複合コンポーネントは `components/` 直下にまとめ、カードやテーブルなど UI 要素を組み合わせて表現する。
- **状態管理**:
  - フィーチャー内部の短命な状態は `useState` / `useReducer` を利用する。
  - アプリ全体で共有するテーマやセッションなどの状態は `store/` に配置した Zustand ストア（例: `useThemeStore`）で集中管理し、`persist` ミドルウェアで `localStorage` に保存する。`lib/auth` は認証情報とローカルストレージの同期を担う。
- **データ取得・API 連携**:
  - HTTP クライアントや Supabase SDK をラップしたサービスを `services/` に集約し、フィーチャー層から利用する。
  - バックエンドと共有する Zod スキーマは `packages/shared` からインポートし、型整合性を保つ。
